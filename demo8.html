<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>demo8-polygonArrayLine</title>
<script>

	//求2d向量夹角
	var angleVector2d = (a, b)=>{
	  let x1 = a[0],
	    y1 = a[1],
	    x2 = b[0],
	    y2 = b[1];
	  
	  let len1 = x1*x1 + y1*y1;
	  if (len1 > 0) {
	    len1 = 1 / Math.sqrt(len1);
	  }
	  
	  let len2 = x2*x2 + y2*y2;
	  if (len2 > 0) {
	    len2 = 1 / Math.sqrt(len2);
	  }
	  
	  let cosine = (x1 * x2 + y1 * y2) * len1 * len2;
	  
	  
	  if(cosine > 1.0) {
	    return 0;
	  }
	  else if(cosine < -1.0) {
	    return Math.PI;
	  } else {
	    return Math.acos(cosine);
	  }
	}
</script>
<meta name="keywords" content="">
<link hpolygonArrowRef="" rel="stylesheet">
<style>
	.svg svg, .svg line:hover , .svg path:hover, .svg polygon:hover, .svg rect:hover, .svg circle:hover, .svg ellipse:hover{
		pointer-events: all;
	}
</style>
</head>
<body>
    <div class="svg" style="width:600px; height:600px;border:1px solid #333; position: relative;">
    	<svg pointer-events="painted" width="600" height="600" id="svg" style="position:absolute; left:0px; top:0px;">
    		<g id="ggg" pointer-events="inherit"></g>

    	</svg>
    	<div style="position: absolute;left:0;top:0; width:100%; height:100%; pointer-events:none;" class="svg-hover"></div>
    </div>
</body>
</html>
<script>
	let svg = document.querySelector('#svg');
	let svgg = svg.querySelector('g');

	class PolygonArrowHoverDrap{
		constructor(polygonProps){
			this.polygonProps = polygonProps;

			//遮罩
			this.drapMaskRef = null;

			//是否正在hover
			this.isHovering = false;
		}

		//阻挡右键默认菜单
		preventDefault(){
			document.querySelector('svg').oncontextmenu = (e)=>{e.preventDefault()}
		}

		
		//hover
		bindHoverEvent(){
			this.polygonProps.polygonArrowRef.onmouseenter = ()=>{
				this.polygonProps.polygonArrowRef.style = this.polygonProps.hoverStyle;
			}
			this.polygonProps.polygonArrowRef.onmouseleave = ()=>{
				this.polygonProps.polygonArrowRef.style = this.polygonProps.style;
			}
		}

		
		//点击箭头
		bindMouseDownEvent(e){
			this.polygonProps.polygonArrowRef.addEventListener('mousedown', e=>{
				this.isHovering = true;
				this.createDrapMask();
				e.stopPropagation();
			});
		}

		//遮罩随鼠标移动
		BindDrapEvent(){
			this.drapMaskRef.onmousedown = e=>{
				let x = e.clientX;
				let y = e.clientY;
				let disx = 0;
				let disy = 0;
				let mousemove = e=>{
					disx = e.clientX - x;
					disy = e.clientY - y;
					x = e.clientX;
					y = e.clientY;

					

					//箭头和遮罩移动一致
					this.drapMaskRef.style.transform = `translate(${this.polygonProps.worldTranslate[0]}px, ${this.polygonProps.worldTranslate[1]}px) translate(${this.polygonProps.arrowTranslate[0]+disx}px, ${this.polygonProps.arrowTranslate[1]+disy}px) rotate(${this.polygonProps.arrowRotate}deg)`;
					this.polygonProps.arrowTranslate = [this.polygonProps.arrowTranslate[0]+disx, this.polygonProps.arrowTranslate[1]+disy];
					this.polygonProps.polygon.setAttrs(this.polygonProps);
				}

				let mouseup= e=>{

					//保存移动偏差
					this.polygonProps.arrowTranslate[0] += disx;
					this.polygonProps.arrowTranslate[1] += disy;
					document.removeEventListener('mousemove', mousemove);
					document.removeEventListener('mouseup', mouseup);
				}
				document.addEventListener('mousemove', mousemove);
				document.addEventListener('mouseup', mouseup);
			}
		}
		
		//给控制点绑定时间
		bindControllerPointEvent(point){

			/**
			 * 1. 确定左右点
			 * 2. 确定旋转基点
			 * 3. 移动后，修改设置 箭头， 遮罩的属性，并保存
			 */
			point.onmousedown = e=>{
				
				point.onmousemove = e=>{
					
					e.stopPropagation();
				}

				e.stopPropagation();
			}
			
		}


		//创建两个移动点
		createControllerPoints(drapMaskRef){
			let createPoint = (align)=>{
				let point = document.createElement('a');
				point.style.href= 'javascript:;';
				point.style.width = point.style.height = '6px';
				point.style.border = '2px solid red';
				point.style.background = '#fff';
				point.style.borderRadius = '10px';
				point.style.cursor = 'initial';
				point.style['pointer-events'] = 'all';
				point.style.position = 'absolute';
				point.style.top = '50%';
				point.style.marginTop = '-5px';
				align == 'left' && (point.style.left = '-10px') || (point.style.right = '-10px');
				return point;
			}
			let leftPoint = createPoint('left');
			let rightPoint = createPoint('right');
			this.bindControllerPointEvent(leftPoint);
			this.bindControllerPointEvent(rightPoint);
			drapMaskRef.appendChild(leftPoint);
			drapMaskRef.appendChild(rightPoint);
		}
		

		//创建遮罩
		createDrapMask(){
			if(!this.polygonProps.canHover) return;
			!this.drapMaskRef && (this.drapMaskRef = document.createElement('div')) & document.querySelector('.svg-hover').appendChild(this.drapMaskRef);

			let styleObj = {
				position:'absolute',
				left:0,
				top:0,
				zIndex:100,
				width:this.polygonProps.width+'px',
				height:this.polygonProps.height+'px',
				display:'block',
				cursor:'move',
				pointerEvents:'all',
				transformOrigin:`0px ${this.polygonProps.height/2}px`,
				transform:`translate(${this.polygonProps.worldTranslate[0]}px, ${this.polygonProps.worldTranslate[1]}px) translate(${this.polygonProps.arrowTranslate[0]}px, ${this.polygonProps.arrowTranslate[1]}px) rotate(${this.polygonProps.arrowRotate}deg)`,

			}
			for(let i in styleObj) this.drapMaskRef.style[i] = styleObj[i];
			document.querySelector('.svg-hover').style.display='block';
			this.polygonProps.polygonArrowRef.style = this.polygonProps.style;
			
			//创建控制点
			this.createControllerPoints(this.drapMaskRef);
			
			//绑定拖拽事件
			this.BindDrapEvent();
			
			//点击右键遮罩
			document.addEventListener('mousedown', this.onDisppear.bind(this));
		}
		

		//消失
		onDisppear(e){
			if(e.button != 2) return;
			this.isHovering = false;
			this.polygonProps['pointer-events'] = 'inherit';
			this.polygonProps.polygon.setAttrs(this.polygonProps);
			this.drapMaskRef && (this.drapMaskRef.style.display='none');
			this.polygonProps.polygonArrowRef.style = this.polygonProps.style;
		}
			
	}

	//初始化
	PolygonArrowHoverDrap.init = (props)=>{
		let _this = new PolygonArrowHoverDrap(props);
		_this.preventDefault();
		_this.bindMouseDownEvent();
		_this.bindHoverEvent();
		return _this;
		
	}
	class createSVG{
		constructor(tag, attrs){
			this.tag = document.createElementNS('http://www.w3.org/2000/svg', tag);
			this.attrs = attrs;
			this.setAttrs(attrs);
		}

		/**
		 * 设置属性
		 * @param {String} name 属性名
		 * @param {String} value 属性值
		 */
		setAttr(name, value){
			this.tag[name] = value;
		}
		/**
		 * 设置属性对象
		 * @param {Object} attrs 属性名
		 */
		setAttrs(attrs){
			for(let attr in attrs){
				if(attr == 'polygonArrowRef' || attr == 'polygon') continue;
				if(attr == 'points'){
					this.tag.setAttribute(attr, attrs[attr].join(' ').toString());	
					continue;
				}
				if(attr == 'worldTranslate' || attr == 'arrowTranslate' || attr == 'arrowRotate'){
					let _attrs = `translate(${attrs.worldTranslate.toString()}) translate(${attrs.arrowTranslate.toString()}) rotate(${attrs.arrowRotate} ${0} ${10})`;
					this.tag.setAttribute('transform', _attrs);
					continue;
				}
				this.tag.setAttribute(attr, attrs[attr]);
	        }
		}
	}
	// 0,3 4,3 4,0 16,6 4,12 4,9 0,9
	/*        	  A	 
			  	  | C 
			  		|
	O----------------|-----X			  		
			  		|
			  	  | D
	          	  B	
	*/

	
	let initY = 10;
	let initX = 16;
	let initH = 20;
	let cornABX = 12;
	let cornCDX = 10;
	let PO1 = [0, initY-1];
	let PO2 = [0, initY+1];
	let PX = [initX, initY];
	let PA = [initX-12, 0];
	let PB = [initX-12, initH];
	let PC = [initX-10, 7];
	let PD = [initX-10, initH-7];
	let initPoints = [PO1, PC, PA, PX, PB, PD, PO2];
	let initWorldTranslate = [0, 0];
	let initArrayTranslate = [0, 0];
	let createAttrs = ()=>{
		return {
			hoverStyle:'fill:green',
			style:'fill:red',
			points:JSON.parse(JSON.stringify(initPoints)),
			// points:[[0, 9], [16, 7], [4,0], [16, 10], [4,20], [16, 20-7], [0, 11]],
			worldTranslate:JSON.parse(JSON.stringify(initWorldTranslate)),
			arrowTranslate:JSON.parse(JSON.stringify(initArrayTranslate)),
			arrowRotate:360,
			polygonArrowRef:null,
			hoverDrapRef:null,
			ox:0,
			oy:0,
			dx:0,
			dy:0,
			width:initX,
			height:initH,
			canHover:false,
			isHovering:false,
			'pointer-events':"inherit"
		}
	};

	
	
	let objBindHover = obj=>{

		//阻挡右键默认菜单
		document.querySelector('svg').oncontextmenu = (e)=>{e.preventDefault()}

		
		//遮罩
		let dom = null;
		obj.polygonArrowRef.onmouseenter = ()=>{
			obj.polygonArrowRef.style = obj.hoverStyle;
		}
		obj.polygonArrowRef.onmouseleave = ()=>{
			obj.polygonArrowRef.style = obj.style;
		}
		obj.polygonArrowRef.onmousedown = (e)=>{
			isHovering = true;
			if(!obj.canHover) return;
			!dom && (dom = document.createElement('div')) & document.querySelector('.svg-hover').appendChild(dom);
			dom.style.position = 'absolute';
			dom.style.left = 0;
			dom.style.top = 0;
			dom.style.zIndex = 100;
			dom.style.width = obj.width+'px';
			dom.style.height = obj.height+'px';
			dom.style.display = 'block';
			dom.style.background='rgba(0, 0, 0, 0.5)';
			dom.style.cursor='move';
			dom.style.pointerEvents='all';
			dom.style.transformOrigin = `0px ${initY}px`;
			dom.style.transform=`translate(${obj.worldTranslate[0]}px, ${obj.worldTranslate[1]}px) rotate(${obj.arrowRotate}deg)`;
			document.querySelector('.svg-hover').style.display='block';
			obj.polygonArrowRef.style = obj.style;


			//there is a bug below
			document.onmousedown = e=>{
				let x = e.clientX;
				let y = e.clientY;
				let mousemove = e=>{
					let disx = e.clientX - x;
					let disy = e.clientY - y;
					dom.style.transform = `translate(${obj.worldTranslate[0]}px, ${obj.worldTranslate[1]}px) translate(${disx}px, ${disy}px) rotate(${obj.arrowRotate}deg)`;
					obj.arrowTranslate = [disx, disy];
					obj.polygon.setAttrs(obj);
				}

				let mouseup= e=>{
					document.removeEventListener('mousemove', mousemove);
					document.removeEventListener('mouseup', mouseup);
				}
				document.addEventListener('mousemove', mousemove);
				document.addEventListener('mouseup', mouseup);
			}

			e.stopPropagation();
		}
		let cancel = (e)=>{
			if(e.button != 2) return;
			isHovering = false;
			obj['pointer-events'] = 'inherit';
			obj.polygon.setAttrs(obj);
			dom && (dom.style.display='none');
			obj.polygonArrowRef.style = obj.style;
		}
		document.addEventListener('mousedown', cancel);
	}
	
	let currentOBJ = {};
	let isHovering = false;
	window.polygonArrowLines = [];
	let onmousedown = e=>{
		if(e.button !=0 ) return;
		if(currentOBJ.hoverDrapRef && currentOBJ.hoverDrapRef.isHovering) return;
		currentOBJ = createAttrs();
		currentOBJ.canHover = false;
		currentOBJ.ox = e.offsetX;
		currentOBJ.oy = e.offsetY-initY;
		currentOBJ.worldTranslate = [currentOBJ.ox, currentOBJ.oy];
		currentOBJ.polygon = new createSVG('polygon', currentOBJ);

		//保存引用
		currentOBJ.polygonArrowRef = currentOBJ.polygon.tag;
		
		//绑定hover事件
		currentOBJ.hoverDrapRef =  PolygonArrowHoverDrap.init(currentOBJ, isHovering);




		svgg.appendChild(currentOBJ.polygon.tag);
		svg.addEventListener('mousemove', onmousemove);
		svg.addEventListener('mouseup', onmouseup);
	}
          

	
	let onmousemove = e=>{
		let x = e.offsetX - currentOBJ.ox;
		let y = e.offsetY- currentOBJ.oy -initY;

		currentOBJ.dx = e.offsetX;
		currentOBJ.dy = e.offsetY;

		//勾股定理
		let newX = Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));

		//当长度小于最小值
		if(newX < initX) newX = initX;

		currentOBJ.width = newX;

		//只修改x值，也就是修改长度
		currentOBJ.points[3][0] = newX;
		currentOBJ.points[1][0] = newX-cornCDX;
		currentOBJ.points[2][0] = newX-cornABX;
		currentOBJ.points[4][0] = newX-cornABX;
		currentOBJ.points[5][0] = newX-cornCDX;

		
		//定义向量，求夹角		
		let newVector = [x, y];
		let oldVector = [currentOBJ.ox, 0];

		let angle = angleVector2d(newVector, oldVector);
		newRotate = angle*180/Math.PI;
		
		//自动吸附到0度
		if(newRotate < 2) newRotate = 0;
		
		//当鼠标移动到初始箭头上方时
		if(e.offsetY < currentOBJ.oy){
			newRotate = 360 - newRotate;
		}

		//自动吸附
		if(newRotate < 182 && newRotate > 178) newRotate = 180;
		
		currentOBJ.arrowRotate = newRotate;
		currentOBJ.polygon.setAttrs(currentOBJ);
	}

	let onmouseup = ()=>{
		currentOBJ.canHover = true;
		polygonArrowLines.push(currentOBJ);
		svg.removeEventListener('mousemove', onmousemove);
		svg.removeEventListener('mouseup', onmouseup);
	}
	svg.addEventListener('mousedown', onmousedown);
</script>
